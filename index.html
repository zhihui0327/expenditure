<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ—¥å¸¸æ”¯å‡ºç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --accent: #764ba2;
            --bg: #f3f4f6;
            --text: #374151;
            --text-light: #9ca3af;
            --white: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        /* é¡¶éƒ¨é€šæ  */
        .header-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--white);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(102, 126, 234, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-info h1 { font-size: 24px; margin-bottom: 5px; }
        .header-info p { opacity: 0.9; font-size: 14px; }

        .month-selector {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            cursor: pointer;
        }
        
        /* Dashboard å¸ƒå±€ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        
        .card:hover { transform: translateY(-2px); }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ç»Ÿè®¡æ•°å­— */
        .stat-value { font-size: 32px; font-weight: 700; color: var(--text); }
        .stat-sub { font-size: 13px; color: var(--text-light); margin-top: 5px; }
        .stat-value.expense { color: var(--primary); }

        /* è¾“å…¥åŒºåŸŸ */
        .input-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .form-group label { display: block; font-size: 12px; color: var(--text-light); margin-bottom: 5px; font-weight: 500;}
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            font-size: 14px;
            transition: all 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid #e5e7eb; color: var(--text); }
        .btn-outline:hover { background: #f3f4f6; }

        /* å›¾è¡¨åŒºåŸŸ */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* è¡¨æ ¼åŒºåŸŸ */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .search-box {
            flex: 1;
            position: relative;
        }
        
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px; color: var(--text-light); font-size: 12px; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: var(--text); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f9fafb; }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .editable-cell {
            cursor: pointer;
            border-bottom: 1px dashed #cbd5e1;
            transition: color 0.2s;
        }
        .editable-cell:hover { color: var(--primary); border-bottom-color: var(--primary); }
        
        .inline-input {
            width: 100%;
            padding: 4px;
            border: 1px solid var(--primary);
            border-radius: 4px;
            font-size: 14px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .header-card { flex-direction: column; text-align: center; }
            .input-form { grid-template-columns: 1fr 1fr; }
            .input-form .form-group:last-child { grid-column: span 2; } /* æŒ‰é’®ç‹¬å ä¸€è¡Œ */
            .btn { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="header-info">
            <h1>ğŸ’° æ”¯å‡ºç®¡ç† Pro</h1>
            <p>æŒæ§è´¢åŠ¡ï¼Œç†æ€§æ¶ˆè´¹</p>
        </div>
        <div>
            <input type="month" id="monthFilter" class="month-selector" onchange="handleMonthChange()">
        </div>
    </div>

    <div class="dashboard-grid">
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div class="card">
                <div class="card-title">ğŸ“ å¿«é€Ÿè®°è´¦</div>
                <div class="input-form">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="dateInput" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç±»</label>
                        <select id="categoryInput" class="form-control">
                            <option value="é¤é¥®">ğŸ” é¤é¥®ç¾é£Ÿ</option>
                            <option value="äº¤é€š">ğŸš— äº¤é€šå‡ºè¡Œ</option>
                            <option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©æ¶ˆè´¹</option>
                            <option value="å¨±ä¹">ğŸ® ä¼‘é—²å¨±ä¹</option>
                            <option value="å±…å®¶">ğŸ¡ å±…å®¶ç”Ÿæ´»</option>
                            <option value="åŒ»ç–—">ğŸ’Š åŒ»ç–—å¥åº·</option>
                            <option value="å­¦ä¹ ">ğŸ“š å­¦ä¹ æå‡</option>
                            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¢ (Â¥)</label>
                        <input type="number" id="amountInput" class="form-control" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="noteInput" class="form-control" placeholder="å¦‚ï¼šè¯·å®¢ã€è¶…å¸‚...">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="addExpense()">+ è®°ä¸€ç¬”</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid" style="gap: 15px;">
                <div class="card" style="padding: 20px;">
                    <div class="card-title">æœ¬æœˆæ”¯å‡º</div>
                    <div class="stat-value expense" id="monthTotal">Â¥0.00</div>
                    <div class="stat-sub" id="recordCount">å…± 0 ç¬”</div>
                </div>
                <div class="card" style="padding: 20px;">
                    <div class="card-title">ä»Šæ—¥æ”¯å‡º</div>
                    <div class="stat-value" id="todayTotal">Â¥0.00</div>
                    <div class="stat-sub">å®æ—¶ç»Ÿè®¡</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span>ğŸ“Š æ¶ˆè´¹æ„æˆ</span>
                <span class="badge" style="background:#f3f4f6; color:#666" id="chartMonthLabel">æœ¬æœˆ</span>
            </div>
            <div class="chart-container">
                <canvas id="expenseChart"></canvas>
            </div>
            <div id="noChartData" style="display:none; text-align:center; padding-top:40px; color:#999;">æœ¬æœˆæš‚æ— æ•°æ®</div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">
            <span>ğŸ“œ è´¦å•æ˜ç»†</span>
            <div class="toolbar">
                <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” æœç´¢å¤‡æ³¨æˆ–é‡‘é¢..." onkeyup="filterTable()">
                <button class="btn btn-outline" onclick="exportExcel()">å¯¼å‡ºExcel</button>
                <button class="btn btn-danger" onclick="clearAll()" style="padding: 8px 12px;">ğŸ—‘ï¸</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table>
                <thead>
                <tr>
                    <th width="15%">æ—¥æœŸ</th>
                    <th width="15%">åˆ†ç±»</th>
                    <th width="15%">é‡‘é¢</th>
                    <th width="40%">å¤‡æ³¨</th>
                    <th width="15%">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="expenseTable">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    // ====== é…ç½®ä¸åˆå§‹åŒ– ======
    const STORAGE_KEY = 'expenses_pro_v2';
    // é¢œè‰²é…ç½®
    const catColors = {
        'é¤é¥®': '#ff6b6b', 'äº¤é€š': '#4ecdc4', 'è´­ç‰©': '#ff9f43',
        'å¨±ä¹': '#a55eea', 'å±…å®¶': '#54a0ff', 'åŒ»ç–—': '#ff7675',
        'å­¦ä¹ ': '#2ecc71', 'å…¶ä»–': '#a4b0be'
    };
    
    let expenses = loadExpenses();
    let expenseChart = null;
    let editingCell = null;

    // åˆå§‹åŒ–ï¼šè®¾ç½®é»˜è®¤æœˆä»½ä¸ºå½“å‰æœˆ
    const today = new Date();
    const currentMonthStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    document.getElementById('monthFilter').value = currentMonthStr;
    document.getElementById('dateInput').value = today.toISOString().split('T')[0];

    // ====== æ ¸å¿ƒé€»è¾‘ ======
    function loadExpenses() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    }

    function saveExpenses() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
        refreshUI();
    }

    // ä¸»åˆ·æ–°å‡½æ•°ï¼šå½“æ•°æ®å˜åŠ¨æˆ–æœˆä»½ç­›é€‰å˜åŠ¨æ—¶è°ƒç”¨
    function refreshUI() {
        const selectedMonth = document.getElementById('monthFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        // 1. è¿‡æ»¤æ•°æ®
        const filteredData = expenses.filter(item => {
            const matchMonth = item.date.startsWith(selectedMonth);
            const matchSearch = item.note.toLowerCase().includes(searchTerm) || 
                                item.amount.toString().includes(searchTerm) ||
                                item.category.includes(searchTerm);
            return matchMonth && matchSearch;
        });

        // æŒ‰æ—¥æœŸé™åºæ’åº
        filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));

        // 2. æ¸²æŸ“è¡¨æ ¼
        renderTable(filteredData);
        
        // 3. è®¡ç®—ç»Ÿè®¡ & æ¸²æŸ“å›¾è¡¨ (åŸºäºé€‰ä¸­æœˆä»½çš„æ‰€æœ‰æ•°æ®ï¼Œå—æœç´¢æ¡†å½±å“è¾ƒå°ï¼Œé€šå¸¸å›¾è¡¨çœ‹å…¨é‡)
        // æ³¨æ„ï¼šå¦‚æœä½ å¸Œæœ›å›¾è¡¨ä¹Ÿéšæœç´¢å˜åŠ¨ï¼Œå°±æŠŠ filteredData ä¼ è¿›å»ã€‚è¿™é‡Œæˆ‘è®©å›¾è¡¨åªå—â€œæœˆä»½â€å½±å“ã€‚
        const monthData = expenses.filter(item => item.date.startsWith(selectedMonth));
        updateStats(monthData);
        renderChart(monthData);
    }

    // æ·»åŠ æ”¯å‡º
    function addExpense() {
        const date = document.getElementById('dateInput').value;
        const category = document.getElementById('categoryInput').value;
        const amount = parseFloat(document.getElementById('amountInput').value);
        const note = document.getElementById('noteInput').value;

        if (!date || isNaN(amount) || amount <= 0) {
            alert('è¯·å¡«å†™æ­£ç¡®çš„æ—¥æœŸå’Œé‡‘é¢ï¼');
            return;
        }

        expenses.unshift({
            id: Date.now(),
            date, category, amount, note
        });

        saveExpenses();
        // é‡ç½®é‡‘é¢å’Œå¤‡æ³¨ï¼Œä¿ç•™æ—¥æœŸæ–¹ä¾¿è¿ç»­è®°è´¦
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        document.getElementById('amountInput').focus();
    }

    // åˆ é™¤æ”¯å‡º
    function deleteExpense(id) {
        if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            expenses = expenses.filter(e => e.id !== id);
            saveExpenses();
        }
    }

    // æ¸…ç©ºæ•°æ®
    function clearAll() {
        if(confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ï¼ç¡®å®šå—ï¼Ÿ')) {
            expenses = [];
            saveExpenses();
        }
    }

    // ====== æ¸²æŸ“é€»è¾‘ ======
    function renderTable(data) {
        const tbody = document.getElementById('expenseTable');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999">ğŸ‘» æœ¬æœˆæ²¡æœ‰ç›¸å…³è®°å½•</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(item => `
            <tr>
                <td>${item.date.slice(5)}</td>
                <td><span class="badge" style="background:${catColors[item.category]}20; color:${catColors[item.category]}">${item.category}</span></td>
                <td class="editable-cell" onclick="editCell(${item.id}, 'amount')" style="font-weight:bold; color:${catColors[item.category]}">
                    Â¥${item.amount.toFixed(2)}
                </td>
                <td class="editable-cell" onclick="editCell(${item.id}, 'note')">
                    ${item.note || '<span style="color:#ddd">æ— å¤‡æ³¨</span>'}
                </td>
                <td>
                    <button class="btn btn-outline" style="padding:4px 8px; font-size:12px; color:#ef4444; border-color:#fee2e2" onclick="deleteExpense(${item.id})">åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
    }

    function updateStats(data) {
        const total = data.reduce((sum, item) => sum + item.amount, 0);
        document.getElementById('monthTotal').textContent = `Â¥${total.toFixed(2)}`;
        document.getElementById('recordCount').textContent = `æœ¬æœˆå…± ${data.length} ç¬”`;

        // ä»Šæ—¥æ”¯å‡º
        const todayStr = new Date().toISOString().split('T')[0];
        const todaySum = expenses.filter(e => e.date === todayStr).reduce((sum, e) => sum + e.amount, 0);
        document.getElementById('todayTotal').textContent = `Â¥${todaySum.toFixed(2)}`;
    }

    // ====== å›¾è¡¨é€»è¾‘ (Chart.js) ======
    function renderChart(data) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        const noDataEl = document.getElementById('noChartData');
        const chartEl = document.querySelector('.chart-container canvas');

        if (data.length === 0) {
            chartEl.style.display = 'none';
            noDataEl.style.display = 'block';
            return;
        } else {
            chartEl.style.display = 'block';
            noDataEl.style.display = 'none';
        }

        // èšåˆæ•°æ®
        const catMap = {};
        data.forEach(item => {
            catMap[item.category] = (catMap[item.category] || 0) + item.amount;
        });

        const labels = Object.keys(catMap);
        const values = Object.values(catMap);
        const bgColors = labels.map(l => catColors[l] || '#ccc');

        if (expenseChart) {
            expenseChart.destroy(); // é”€æ¯æ—§å›¾è¡¨
        }

        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: {size: 11} } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const val = context.raw;
                                const total = context.chart._metasets[context.datasetIndex].total;
                                const percent = ((val / total) * 100).toFixed(1) + '%';
                                return ` ${context.label}: Â¥${val} (${percent})`;
                            }
                        }
                    }
                },
                cutout: '65%' // ç”œç”œåœˆåšåº¦
            }
        });
    }

    // ====== äº¤äº’é€»è¾‘ ======
    function handleMonthChange() {
        document.getElementById('chartMonthLabel').textContent = document.getElementById('monthFilter').value;
        refreshUI();
    }

    function filterTable() {
        refreshUI(); // å¤ç”¨åˆ·æ–°é€»è¾‘ï¼Œå› ä¸ºé‡Œé¢åŒ…å«äº†æœç´¢è¯è·å–
    }

    // è¡Œå†…ç¼–è¾‘åŠŸèƒ½
    function editCell(id, field) {
        if (editingCell) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
        
        const item = expenses.find(e => e.id === id);
        if (!item) return;

        // æ‰¾åˆ°ç‚¹å‡»çš„TDå…ƒç´ ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œé€šè¿‡é‡ç»˜æ¥å®šä½æœ‰ç‚¹ç¬¨ï¼Œä½†ç¨³å¥ï¼‰
        // å®é™…ä¸Šå› ä¸º renderTable æ¯æ¬¡é‡ç»˜ï¼Œç›´æ¥æ“ä½œ DOM æ¯”è¾ƒå¤æ‚ï¼Œ
        // è¿™é‡Œæˆ‘ä»¬ç”¨æœ€ç®€å•çš„ prompt æ¥æ›¿ä»£å¤æ‚çš„ DOM æ›¿æ¢ï¼Œæˆ–è€…ç”¨æ›´ä¼˜é›…çš„ inline input æ›¿æ¢
        
        // ä¸ºäº†æ›´å¥½çš„ä½“éªŒï¼Œæˆ‘ä»¬ä½¿ç”¨ DOM æ›¿æ¢æ³•
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼Œä½†æŠŠç‰¹å®šè¡Œæ ‡è®°ä¸ºç¼–è¾‘æ€ (ç®€å•èµ·è§ï¼Œè¿™é‡Œæ¼”ç¤º Prompt æ–¹å¼ï¼Œå¦‚æœéœ€è¦å®Œå…¨ inline æ¯”è¾ƒå¤šä»£ç )
        // ä¸ºäº†ä¸ç ´åä½ è¦æ±‚çš„ç®€æ´æ€§ï¼Œæˆ‘ä»¬ç”¨ Promptï¼Œä½†åšä¸€ç‚¹ä¼˜åŒ–
        
        let newValue;
        if (field === 'amount') {
            const val = prompt("ä¿®æ”¹é‡‘é¢:", item.amount);
            if (val === null) return;
            newValue = parseFloat(val);
            if (isNaN(newValue) || newValue <= 0) { alert("æ— æ•ˆé‡‘é¢"); return; }
        } else {
            const val = prompt("ä¿®æ”¹å¤‡æ³¨:", item.note);
            if (val === null) return;
            newValue = val;
        }

        // æ›´æ–°æ•°æ®
        item[field] = newValue;
        saveExpenses();
    }

    // ====== å¯¼å‡º Excel ======
    function exportExcel() {
        if (!expenses.length) return alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
        
        const ws = XLSX.utils.json_to_sheet(expenses.map(e => ({
            "æ—¥æœŸ": e.date,
            "åˆ†ç±»": e.category,
            "é‡‘é¢": e.amount,
            "å¤‡æ³¨": e.note
        })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æ”¯å‡ºè®°å½•");
        XLSX.writeFile(wb, `æ”¯å‡ºæŠ¥è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // å¯åŠ¨
    refreshUI();

</script>
</body>
</html>
